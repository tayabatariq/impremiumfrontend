<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Business Dashboard - TaskTracker</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />

    <style>
        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            background-color: #D51B1C;
            color: #fff;
        }

        .sidebar .nav-link {
            color: #fff;
            margin: 4px 0;
        }

        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .output-box {
            border: 1px dashed #ccc;
            min-height: 150px;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
            white-space: pre-line;
        }

        /* Initially hide dashboard main-content */
        #dashboardContainer {
            display: none;
        }

        /* Center loading spinner */
        #loadingScreen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body {
            height: inherit;
            width: 100%;
        }

        /* Main content hidden until preloader ends */
        #main-content {
            display: none;
            height: 100%;
            display: grid;
            place-items: center;
            text-align: center;
        }

        /* Preloader overlay */
        #preloader {
            position: fixed;
            inset: 0;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Logo itself as a circle */
        .logo {
            width: 100px;
            height: 100px;
            background: url('preloader.png') no-repeat center/cover;
            animation: logoAnim 7s ease forwards;
            animation: zoomEffect 3s infinite ease-in-out;
        }

        @keyframes logoAnim {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            15% {
                opacity: 1;
                transform: scale(1);
            }

            85% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(1.05);
            }
        }

        @keyframes zoomEffect {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.08);
            }

            100% {
                transform: scale(1);
            }
        }

        .nav-images {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .nav-images a {
            width: 80px;
        }

        .nav-images img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .nav-images img:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .nav-images {
                flex-direction: row;
                flex-wrap: wrap !important;
                justify-content: start;
                gap: 2rem;
            }

            .nav-images a {
                flex: 1 1 30%;
                max-width: 80px;
            }
        }

        .nav-images .nav-link {
            display: inline-block;
            padding: 6px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .navbardashboard {
            background-color: #D51B1C !important;
        }

        .nav-images .nav-link img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .nav-images .nav-link:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        @media (max-width: 991px) {
            .sidebar {
                width: 100%;
                order: -1;
                margin-bottom: 15px;
                position: static !important;
                height: auto !important;
            }

            footer {
                padding: 1rem 3rem !important;
            }
        }

        .bgaitol {
            background-color: rgb(3, 45, 73) !important;
        }

        .menu-icon {
            font-size: 3rem;
            font-weight: bold;
        }

        .signout {
            margin-top: 1rem !important;
            font-weight: 400 !important;
            color: #333;
            background-color: transparent;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }

        .signout:hover {
            background-color: #f44336;
            color: #fff;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            transform: translateY(-2px);
        }

        @media screen and (max-width: 767px) {
            .signout {
                margin-top: -1.1rem !important;
                font-weight: 200 !important;
                padding: .2rem !important;
                font-size: .9rem !important;
            }
        }

        .container-fluid {
            flex-wrap: nowrap !important;
        }

        .bgtiktok {
            background-color: rgb(228, 228, 228) !important;
        }

        .menulinkicon {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }

        .bgmsgmenu {
            background-color: #ffffff !important;
        }

        footer {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            font-weight: 300;
            font-size: 14px;
            padding: 3rem 10rem;
        }

        :root {
            --brand-red: #D51B1C;
            --brand-white: #ffffff;
        }

        body {
            background: var(--brand-white);
            color: #222
        }

        .brand-header {
            background: var(--brand-red);
            color: var(--brand-white)
        }

        .btn-brand {
            background: var(--brand-red);
            color: var(--brand-white);
            border: 0
        }

        .task-card {
            border-left: 4px solid var(--brand-red);
        }

        .small-muted {
            font-size: 0.85rem;
            color: #666
        }

        .progress {
            height: 12px;
        }

        .file-preview {
            font-size: 0.85rem;
            color: #444
        }

        @media (max-width:768px) {
            .desktop-only {
                display: none
            }
        }

        /* Mobile view me sticky remove kardo */
        @media (max-width: 991px) {
            .sidebar {
                position: static !important;
                height: auto !important;
            }

            footer {
                padding: 1rem 3rem !important;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            border-radius: 12px;
        }

        .btn-danger {
            border-radius: 10px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            table thead {
                display: none;
                /* header chhupa do */
            }

            table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 10px;
            }

            table td {
                display: block;
                text-align: left;
                padding: 8px 10px;
            }

            table td::before {
                content: attr(data-label);
                font-weight: bold;
                display: block;
                margin-bottom: 5px;
                color: #dc3545;
                /* bootstrap danger color */
            }
        }
    </style>
    <link rel="stylesheet" href="admindahbaord.css">
    <!-- SweetAlert2 CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>

    <!-- Preloader Screen -->
    <div id="preloader">
        <div class="logo"></div>
    </div>

    <!-- Loading Screen (quick check) -->
    <div id="loadingScreen" class="d-none">
        <div class="text-center">
            <div class="spinner-border text-danger" role="status"></div>
            <p class="mt-2 text-muted">Checking login...</p>
        </div>
    </div>

    <!-- Dashboard Container (shown after login & preloader) -->
    <div id="dashboardContainer">
        <!-- Top Navbar -->
        <nav class="navbar navbardashboard shadow-sm px-3">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h5 ">
                    <span class="me-3 text-white small" id="welcomeMsg">
                        <strong>User</strong>
                    </span>
                </span>

                <div>
                    <!-- Mobile Menu Button -->
                    <button class="btn btn-lg text-white d-block d-md-none" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#mobileSidebar">
                        <i class="bi bi-list menu-icon"></i>
                    </button>
                    <button onclick="logout()" class="btn signout">
                        Sign Out <i class="ri-settings-2-line"></i>
                    </button>
                </div>
            </div>

            <!-- Offcanvas Sidebar for Mobile -->
            <div style="background-color:#D51B1C; color: white;" class="offcanvas offcanvas-end" tabindex="-1"
                id="mobileSidebar">
                <div class="offcanvas-header">
                    <h5 class="text-white offcanvas-title">Menu</h5>
                    <button style="color: white;" type="button" class="btn-close  text-reset"
                        data-bs-dismiss="offcanvas"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="list-unstyled">
                        <li>
                            <a href="#" class="btn text-white w-100 text-start">
                                <i class="bi bi-box-arrow-right me-1"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar (works for both desktop + mobile) -->
               
                <!-- Main Content -->
                <div class="col-lg-10 p-4 min-vh-100" id="main-area">
                    <main class="mainsec">
                        <!-- Create Project Form -->
                        <section class="card createproject">
                            <h2>Create a New Project</h2>
                            <form id="createProjectForm">
                                <input type="text" id="title" placeholder="Project Title" required />
                                <textarea id="description" placeholder="Project Description" required></textarea>
                                <button type="submit">Create Project</button>
                            </form>
                        </section>

                        <!-- Display Projects -->
                        <section class="card">
                            <h2>Your Projects</h2>
                            <div id="projectsList" class="projects"></div>
                        </section>
                    </main>
                    <!-- Navbar -->
                    <nav class="navbar navbar-expand-lg navbar-dark ourbtn shadow">
                        <div class="container">
                            <a class="navbar-brand fw-bold" href="#">Employee Manager</a>
                        </div>
                    </nav>

                    <!-- Main Container -->
                    <div class="container my-4">
                        <div class="mainsec">
                            <!-- Add Employee Form -->
                            <div class="card shadow p-3 mb-4">
                                <h4 class="mb-3 text-danger">Add Employee</h4>
                                <form id="employeeForm">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="name" placeholder="Enter name"
                                                required>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="email" class="form-control" id="email"
                                                placeholder="Enter email" required>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control" id="password"
                                                placeholder="Enter password" required>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn text-white ourbtn mt-3">Create Employee</button>
                                </form>
                            </div>

                            <!-- Employee List -->
                            <div class="card shadow">
                                <div class="card-header ourbtn text-white">
                                    <h5 class="mb-0 ">Employee List</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-hover text-center" id="employeeTable">
                                        <thead class="table-danger">
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="employeeTableBody">
                                            <!-- Dynamic Rows Here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <nav class="navbar navbar-expand-lg  " style="background-color: #D51B1C;">
                        <div class="container" >
                            <span class="navbar-brand ourbtn ">Task Manager</span>
                        </div>
                    </nav>

                    <div class="container my-4">
                        <!-- Assign Task Form -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header  text-white" style="background-color: #D51B1C;">
                                Assign New Task
                            </div>
                            <div class="card-body">
                                <form id="assignTaskForm">
                                    <div class="mb-3">
                                        <label for="taskTitle" class="form-label">Task Title</label>
                                        <input type="text" class="form-control" id="taskTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="taskDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="taskDescription" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="taskDeadline" class="form-label">Deadline</label>
                                        <input type="date" class="form-control" id="taskDeadline" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="projectSelect" class="form-label">Select Project</label>
                                        <select class="form-select" id="projectSelect" required>
                                            <option value="">Loading projects...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="employeeSelect" class="form-label">Assign To</label>
                                        <select class="form-select" id="employeeSelect" required>
                                            <option value="">Loading employees...</option>
                                        </select>
                                    </div>
                                    <button type="submit" style="background-color: #D51B1C;" class="btn btn-primary w-100">Assign Task</button>
                                </form>
                            </div>
                        </div>

                        <!-- Task List -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                Project Tasks
                            </div>
                            <div class="card-body">
                                <table class="table table-striped" id="taskTable">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Assigned To</th>
                                            <th>Status</th>
                                            <th>Deadline</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Modal for Progress Update -->
                    <div class="modal fade" id="progressModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Update Progress</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="progressForm">
                                        <input type="hidden" id="progressTaskId">
                                        <div class="mb-3">
                                            <label for="completion" class="form-label">Completion (%)</label>
                                            <input type="number" class="form-control" id="completion" min="0" max="100" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="status" class="form-label">Status</label>
                                            <select class="form-select" id="status">
                                                <option value="To Do">To Do</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Done">Done</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">Update</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="text-center mt-5">
                Â© 2025 Imperium Media Enterprises Ltd | Company No. 16496865 |
                A company registered in England and Wales. All rights reserved.
                For more details about our services and policies, please visit
                <a href="https://www.imperiummedia.co.uk" class="text-white text-decoration-none">
                    www.imperiummedia.co.uk
                </a>.
            </footer>
        </div>
    </div>

    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Fixed user credentials
const FIXED_EMAIL = "impremium76@gmail.com";
const FIXED_PASSWORD = "asdfghjkl@9012"; // This should be the password used for login

        // Global variables
        const API_URL = "https://impremiumbackend.vercel.app/api/projects";
        const EMPLOYEE_API = "https://impremiumbackend.vercel.app/api/employees";
        const TASK_API = "https://impremiumbackend.vercel.app/api/tasks";
        
        // Get token and user info
        const token = localStorage.getItem("token");
        const user = JSON.parse(localStorage.getItem("user"));
        const EMPLOYER_ID = user?.id;

        // Check if user is logged in
       window.addEventListener("DOMContentLoaded", () => {
    if (!token || !user) {
        window.location.href = "login.html";
        return;
    }

    // âœ… Check if user email matches the fixed email
    if (user.email !== FIXED_EMAIL) {
        alert("You are not authorized to access this page!");
        window.location.href = "login.html";
        return;
    }

    document.getElementById("welcomeMsg").innerHTML =
        `<span style="font-weight:300;"> Welcome ðŸ‘‹ , <br> Logged in As </span> <span style="font-weight:500;" >${user.name}</span>`;

    document.getElementById("loadingScreen").style.display = "none";
    document.getElementById("dashboardContainer").style.display = "block";

    // Load data
    fetchProjects();
    fetchEmployees();
    loadDropdowns();
});


        // Logout function
        function logout() {
            localStorage.removeItem("user");
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }

        // Project functions
        async function fetchProjects() {
            try {
                const res = await fetch(`${API_URL}`, {
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!res.ok) throw new Error("Failed to fetch projects");
                
                const projects = await res.json();
                const projectsList = document.getElementById("projectsList");
                projectsList.innerHTML = "";

                if (projects.length === 0) {
                    projectsList.innerHTML = `<p style="color:gray;">No projects created yet.</p>`;
                    return;
                }

                projects.forEach(project => {
                    const div = document.createElement("div");
                    div.classList.add("project-card", "mb-3", "p-3", "border", "rounded");
                    div.innerHTML = `
                        <h3>${project.title}</h3>
                        <p>${project.description}</p>
                        <button class="btn ourbtn text-white btn-sm me-2" onclick="generateClientLink('${project._id}')">Generate Client Link</button>
                        <button class="btn ourbtn text-white btn-sm" onclick="deleteProject('${project._id}')">Delete</button>
                        <span id="link-${project._id}"></span>
                    `;
                    projectsList.appendChild(div);
                });
            } catch (err) {
                console.error("Error fetching projects:", err);
                document.getElementById("projectsList").innerHTML = `<p style="color:red;">Error loading projects</p>`;
            }

        }

        // Create project
        document.getElementById("createProjectForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const title = document.getElementById("title").value.trim();
            const description = document.getElementById("description").value.trim();

            if (!title) {
                alert("Title is required!");
                return;
            }

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ title, description })
                });

                if (res.ok) {
                    document.getElementById("createProjectForm").reset();
                    fetchProjects();
                    loadDropdowns(); // Reload dropdowns to include new project
                } else {
                    const errData = await res.json();
                    alert(errData.msg || "Failed to create project");
                }
            } catch (err) {
                console.error("Error creating project:", err);
                alert("Something went wrong while creating project!");
            }
        });

        // Delete project
        async function deleteProject(projectId) {
            const result = await Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Yes, delete it!"
            });
console.log("Deleting project:", projectId);
           
        // âœ… Correct way to save projectId in localStorage
        localStorage.setItem("projectId", projectId);

            if (!result.isConfirmed) return;

            try {
                const res = await fetch(`${API_URL}/${projectId}`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                const data = await res.json();

                if (res.ok) {
                    Swal.fire({
                        title: "Deleted!",
                        text: data.msg || "Your project has been deleted.",
                        icon: "success",
                        confirmButtonColor: "#3085d6"
                    });
                    fetchProjects();
                    loadDropdowns(); // Reload dropdowns after deletion
                } else {
                    Swal.fire({
                        title: "Error!",
                        text: data.msg || "Failed to delete project",
                        icon: "error",
                        confirmButtonColor: "#d33"
                    });
                }
            } catch (err) {
                console.error("Error deleting project:", err);
                Swal.fire({
                    title: "Oops!",
                    text: "Something went wrong while deleting project!",
                    icon: "error",
                    confirmButtonColor: "#d33"
                });
            }
        }

        // Generate client link
        async function generateClientLink(projectId) {
            try {
                const res = await fetch(`${API_URL}/${projectId}/client-link`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                const data = await res.json();
                const linkContainer = document.getElementById(`link-${projectId}`);
                
                if (res.ok) {
                    linkContainer.innerHTML = `
                        <div class="mt-2">
                            <input type="text" class="form-control d-inline-block w-50 me-2" id="linkInput-${projectId}" value="${data.clientLink}" readonly>
                            <button class="btn btn-success btn-sm" onclick="copyToClipboard('${data.clientLink}', this)">Copy Link</button>
                        </div>
                    `;
                } else {
                    linkContainer.innerHTML = `<p class="text-danger mt-2">Failed to generate link</p>`;
                }
            } catch (err) {
                console.error("Error generating client link:", err);
                alert("Failed to generate client link");
            }
        }

        // Copy to clipboard
        function copyToClipboard(link, btn) {
            navigator.clipboard.writeText(link).then(() => {
                const originalText = btn.innerText;
                btn.innerText = "Copied! âœ…";
                btn.classList.remove("btn-success");
                btn.classList.add("btn-secondary");

                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.remove("btn-secondary");
                    btn.classList.add("btn-success");
                }, 2000);
            }).catch(err => {
                console.error("Failed to copy:", err);
                alert("Failed to copy link");
            });
        }

        // Employee functions
       document.getElementById("employeeForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try {
        const res = await fetch(EMPLOYEE_API, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ name, email, password })
        });

        const data = await res.json();
        if (res.ok) {
            // âœ… Employee ID ko localStorage me save karo
            if (data.employee && data.employee._id) {
                localStorage.setItem("employeeId", data.employee._id);
            }

            document.getElementById("employeeForm").reset();
            fetchEmployees();
            loadDropdowns(); // Reload dropdowns to include new employee
            Swal.fire("Success", data.msg, "success");
        } else {
            Swal.fire("Error", data.msg, "error");
        }
    } catch (err) {
        console.error(err);
        Swal.fire("Error", "Something went wrong", "error");
    }
});


        // Fetch employees
        async function fetchEmployees() {
            try {
                const res = await fetch(EMPLOYEE_API, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error("Failed to fetch employees");
                
                const data = await res.json();
                const employeeTableBody = document.getElementById("employeeTableBody");
                employeeTableBody.innerHTML = "";
                
                if (data.employees && data.employees.length > 0) {
                    data.employees.forEach(emp => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${emp.employee.name}</td>
                            <td>${emp.employee.email}</td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteEmployee('${emp.employee._id}')">
                                    Delete
                                </button>
                            </td>`;
                        employeeTableBody.appendChild(tr);
                    });
                } else {
                    employeeTableBody.innerHTML = `<tr><td colspan="3" class="text-center">No employees found</td></tr>`;
                }
            } catch (err) {
                console.error(err);
                Swal.fire("Error", "Unable to fetch employees", "error");
            }
        }

        // Delete employee
        async function deleteEmployee(id) {
            const confirmResult = await Swal.fire({
                title: "Are you sure?",
                text: "This employee will be permanently deleted!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#6c757d",
                confirmButtonText: "Yes, delete it!"
            });

            if (!confirmResult.isConfirmed) return;

            try {
                const res = await fetch(`${EMPLOYEE_API}/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });

                const data = await res.json();
                if (res.ok) {
                    fetchEmployees();
                    loadDropdowns(); // Reload dropdowns after deletion
                    Swal.fire("Deleted!", data.msg, "success");
                } else {
                    Swal.fire("Error", data.msg, "error");
                }
            } catch (err) {
                console.error(err);
                Swal.fire("Error", "Failed to delete employee", "error");
            }
        }

        // Task functions - Load dropdowns for projects and employees
        async function loadDropdowns() {
            try {
                // Load projects
                const projectRes = await fetch(`${API_URL}`, {
                    headers: { 
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                
                if (projectRes.ok) {
                    const projects = await projectRes.json();
                    const projectSelect = document.getElementById("projectSelect");
                    projectSelect.innerHTML = `<option value="">Select a project</option>`;
                    
                    projects.forEach(p => {
                        projectSelect.innerHTML += `<option value="${p._id}">${p.title}</option>`;
                    });
                }

                // Load employees
                const employeeRes = await fetch(EMPLOYEE_API, {
                    headers: { 
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                
                if (employeeRes.ok) {
                    const data = await employeeRes.json();
                    const employeeSelect = document.getElementById("employeeSelect");
                    employeeSelect.innerHTML = `<option value="">Select an employee</option>`;
                    
                    if (data.employees && data.employees.length > 0) {
                        data.employees.forEach(e => {
                            employeeSelect.innerHTML += `<option value="${e.employee._id}">${e.employee.name} (${e.employee.email})</option>`;
                        });
                    }
                }
            } catch (err) {
                console.error("Error loading dropdowns", err);
            }
        }

        // Fetch and display tasks for selected project
        async function fetchTasks() {
            const projectId = document.getElementById("projectSelect").value;
            if (!projectId) return;
            
            try {
                const res = await fetch(`${TASK_API}/project/${projectId}`, {
                    headers: { 
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                
                if (res.ok) {
                    const tasks = await res.json();
                    renderTasks(tasks);
                } else {
                    console.error("Failed to fetch tasks");
                }
            } catch (err) {
                console.error("Error fetching tasks", err);
            }
        }

        // Render tasks in table
        function renderTasks(tasks) {
            const tbody = document.querySelector("#taskTable tbody");
            tbody.innerHTML = "";
            
            if (tasks && tasks.length > 0) {
                tasks.forEach(task => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${task.title}</td>
                           <td>${task.assignedTo?.employee?.name || task.assignedTo?.name || "N/A"}</td>

                            <td>${task.status || "To Do"}</td>
                            <td>${task.deadline ? new Date(task.deadline).toLocaleDateString() : "N/A"}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="openProgressModal('${task._id}')">Update</button>
                            </td>
                        </tr>`;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">No tasks found for this project</td></tr>`;
            }
        }

        // Handle assign task
        document.getElementById("assignTaskForm").addEventListener("submit", async (e) => {
            e.preventDefault();
           const taskData = {
    title: document.getElementById("taskTitle").value,
    description: document.getElementById("taskDescription").value,
    deadline: document.getElementById("taskDeadline").value,
    projectId: document.getElementById("projectSelect").value,
    assignedTo: document.getElementById("employeeSelect").value, // fix here
};

            try {
                const res = await fetch(TASK_API, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(taskData),
                });

                if (res.ok) {
                    Swal.fire("Success", "Task assigned successfully!", "success");
                    fetchTasks();
                    document.getElementById("assignTaskForm").reset();
                } else {
                    const errorData = await res.json();
                    Swal.fire("Error", errorData.msg || "Error assigning task", "error");
                }
            } catch (err) {
                console.error("Error assigning task:", err);
                Swal.fire("Error", "Something went wrong while assigning task", "error");
            }
        });

        // Open progress modal
        function openProgressModal(taskId) {
            document.getElementById("progressTaskId").value = taskId;
            const modal = new bootstrap.Modal(document.getElementById("progressModal"));
            modal.show();
        }

        // Handle progress update
        document.getElementById("progressForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const taskId = document.getElementById("progressTaskId").value;
            const data = {
                completion: document.getElementById("completion").value,
                status: document.getElementById("status").value,
            };

            try {
                const res = await fetch(`${TASK_API}/${taskId}/progress`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(data),
                });

                if (res.ok) {
                    Swal.fire("Success", "Progress updated successfully!", "success");
                    fetchTasks();
                    bootstrap.Modal.getInstance(document.getElementById("progressModal")).hide();
                } else {
                    const errorData = await res.json();
                    Swal.fire("Error", errorData.msg || "Error updating progress", "error");
                }
            } catch (err) {
                console.error("Error updating progress:", err);
                Swal.fire("Error", "Something went wrong while updating progress", "error");
            }
        });

        // Auto-fetch tasks when project changes
        document.getElementById("projectSelect").addEventListener("change", fetchTasks);

        // Preloader timeout
        window.addEventListener("load", function () {
            const preloader = document.getElementById("preloader");
            setTimeout(() => {
                preloader.style.transition = "opacity 0.8s ease";
                preloader.style.opacity = 0;
                setTimeout(() => {
                    preloader.style.display = "none";
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                }, 800);
            }, 3000);
        });
    </script>
    
</body>
</html>